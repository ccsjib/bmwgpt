(async function() {
    console.log("Starting Smart FCP Euro Downloader (with Anti-429 logic)...");

    // --- CONFIGURATION ---
    const MIN_DELAY = 4000;       // Minimum wait between articles (4 seconds)
    const MAX_DELAY = 8000;       // Maximum wait between articles (8 seconds)
    const RETRY_WAIT = 5000;     // If 429 error, wait 5 seconds before retrying
    const MAX_RETRIES = 3;        // How many times to retry a single link

    // --- HELPERS ---

    // Sleep for a random amount of time between min and max
    const randomDelay = () => {
        const ms = Math.floor(Math.random() * (MAX_DELAY - MIN_DELAY + 1) + MIN_DELAY);
        return new Promise(r => setTimeout(r, ms));
    };

    // Sleep for a specific amount of time
    const wait = (ms) => new Promise(r => setTimeout(r, ms));

    // Smart Fetch with Retry Logic
    async function fetchWithRetry(url, attempt = 1) {
        try {
            const response = await fetch(url);

            if (response.status === 429) {
                if (attempt > MAX_RETRIES) throw new Error("Max retries exceeded");
                
                console.warn(`‚õî 429 Rate Limit hit on: ${url}`);
                console.warn(`   ‚è≥ Cooling down for ${RETRY_WAIT / 1000} seconds...`);
                
                await wait(RETRY_WAIT);
                console.log(`   üîÑ Retrying (Attempt ${attempt + 1})...`);
                return fetchWithRetry(url, attempt + 1);
            }

            if (!response.ok) {
                console.error(`   ‚ùå Server error ${response.status} on ${url}`);
                return null;
            }

            return response;
        } catch (err) {
            console.error(`   ‚ö†Ô∏è Network error on ${url}`, err);
            return null;
        }
    }

    // Trigger file download
    function download(content, filename) {
        const blob = new Blob([content], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // --- MAIN LOGIC ---
    
    const seenUrls = new Set();
    let currentListingUrl = window.location.href;
    let pageCount = 1;

    while (currentListingUrl) {
        console.log(`\nüìÇ Processing Page ${pageCount}: ${currentListingUrl}`);

        let doc;
        
        // Fetch listing page (with retry protection)
        if (currentListingUrl === window.location.href && pageCount === 1) {
            doc = document;
        } else {
            const res = await fetchWithRetry(currentListingUrl);
            if (!res) {
                console.error("Skipping listing page due to error.");
                break;
            }
            const text = await res.text();
            doc = new DOMParser().parseFromString(text, 'text/html');
        }

        // Extract Links
        const allLinks = Array.from(doc.querySelectorAll('a[href*="/blog/"]'));
        const articleLinks = allLinks
            .map(a => a.href)
            .filter(href => 
                !href.includes('/tag/') && 
                !href.includes('/page/') && 
                !href.includes('/category/') && 
                !href.includes('#') &&
                href.split('/').pop().length > 0
            );

        const uniqueLinks = [...new Set(articleLinks)];
        console.log(`   Found ${uniqueLinks.length} articles.`);

        // Process Articles
        for (const link of uniqueLinks) {
            if (seenUrls.has(link)) continue;
            seenUrls.add(link);

            const filename = link.split('/').filter(s => s).pop() + '.html';
            console.log(`   ‚¨áÔ∏è Downloading: ${filename}`);
            
            const artRes = await fetchWithRetry(link);
            
            if (artRes) {
                const artText = await artRes.text();
                download(artText, filename);
            }

            // Random delay to mimic human behavior
            await randomDelay();
        }

        // Find Next Page
        const nextBtn = Array.from(doc.querySelectorAll('a')).find(el => el.textContent.includes('‚ñ∏'));
        
        if (nextBtn && nextBtn.href) {
            currentListingUrl = nextBtn.href;
            pageCount++;
            console.log(`   ‚û°Ô∏è Moving to page ${pageCount}...`);
            await randomDelay(); // Pause before loading the next listing page too
        } else {
            console.log("\n‚úÖ Done. No more pages.");
            currentListingUrl = null;
        }
    }
})();